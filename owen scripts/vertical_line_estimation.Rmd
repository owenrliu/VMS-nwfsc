---
title: "Vertical Line Density Estimation"
output:
  html_document:
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Introduction

Building on other analyses attempting to quantify spatial effort in the Dungeness fishery, and its relationship to whale entanglement risk, we propose here a new way to estimate the density of vertical lines in a given area in the Dungeness crab fishery on the U.S. West Coast.

The precision and utility of any estimate of spatiotemporal fishing effort is dependent upon the underlying data available in the system. The primary source used in the below analyses are Vessel Monitoring System (VMS) data---approximate hourly geolocations for a subset of fishing vessels on the U.S. west coast from 2009-2018. These data have the advantage of being spatially explicit, but the data do not include information on the number of traps fished or the "soak time" (time in the water between check by the fisher) of each trap. Hence, we will have to estimate density of traps---and therefore vertical lines---through different means.

# Proposed Estimation

## Data Pre-processing

Currently, the VMS data are organized by trip and have been joined to PacFin fish ticket data. That is, for a given landings receipt that indicates the pounds of crab caught, we have geolocation records pertaining to the trip that presumably led to those landings.

The cleaning of the data has been done elsewhere, but for the purposes of the following plots, the important points are:

* Raw VMS data were cleaned and checked for errors, and then linearly interpolated and regularized. We linearly interpolated between recorded VMS points to obtain a relative measure of speed and distance traveled during each trip, then regularized those data, choosing points along the paths such that we have a VMS record for each vessel at more regular time intervals. This means that we do not have extremely fine-scale records of when a vessel, e.g., slowed down, started fishing, or began transiting back to port.
* A fishing "trip" (the unit of many of the analyses below) is defined as the collection of VMS records preceding a landed, recorded PacFIN fish ticket. This means that one "trip" could involve multiple returns to port by a vessel across multiple days, as long as there is no ticket submitted within that time frame.
* In data processing, VMS records were assigned to fish tickets using two criteria. First, for each ticket, we looked backwards to see when the previous ticket had been submitted, and assigned all VMS records after the previous ticket to the current ticket. Second, for those vessels with long periods between submitted tickets, we enforced a 10 day "lookback window", such that the maximum number of calendar days of VMS records that could be associated with a single ticket is 10.
* We are focused here on fishing trips for Dungeness crab, but some vessels can participate in multiple fisheries. In data processing, if multiple tickets were submitted by a vessel on the same day, we denoted the primary target species for that trip as the species with the most landed pounds across all tickets. However, we also marked those trips so we can investigate any differences between single and multispecies fishing trips.

## Estimating Vertical Line Density

The goal of the analysis is to get an idea of the density of crab pot lines in the water in any given place and time during the Dungeness crab season. To do this, we will take the relatively simple approach of multiplying the distance traveled by each vessel during a fishing trip by the expected number of crab pots deployed along each mile of that trip.

Because we do not currently have string-level data of how many traps are fished by individual fishers, we must estimate the number of traps. According to previous studies (NMFS 2005), common spacing of Dungeness crab traps along a contour line is 10-25 pots per mile, with an average of 15. Soak times (unattended time spent in the water) of these traps varies from less than 1 day to 7 days or more. Moreover, both the number of pots fished and the soak time can vary throughout the crab season, depending on prevailing conditions and market conditions. Nevertheless, these previous estimates can serve as bounds on our analysis and provide a basis for sensitivity analysis of our results.

We will be estimating the number of traps fished within the confines of each individual Dungeness crab fishing trip (with "trip" defined as above). We will try two different estimation methods and compare them. For both methods, we first calculate, from VMS data, the total distance traveled by a vessel during a fishing trip. Then, for the first method, we assign a total number of traps based on that distance travel and place them randomly within the footprint of the fishing trip. In the second method, we place the traps evenly along straight segments between actual VMS pings.

From a technical standpoint, we will:

1. Remove the first and last VMS segment from each fishing trip, which are presumably spent mostly transiting to and from a port.
2. Calculate the remaining distance traveled in each VMS segment within each trip
3. For the first method:
  i) Calculate a convex hull around all of the remaining VMS points for that trip
  ii) Calculate the number of traps to deploy based on the distance traveled during the trip and a number of pots per mile
  iii) Randomly place those traps within the convex hull of the fishing trip
4. For the second method:
  i) Calculate the number of traps to deploy based on the distance traveled during the trip and a number of pots per mile
  ii) Place the traps in even segments along straight lines between VMS points
5. For both methods, calculate and display distribution and density of assigned crab pots

To see this visually, we start with an example from a single fishing trip.

# A Sample Dungeness Fishing Trip

```{r pkgs, include=FALSE,message=F,warning=FALSE}
library(tidyverse)
library(knitr)
library(extrafont)
library(ggsci)
library(lubridate)
library(sf)
library(geosphere)
library(magrittr)
library(rnaturalearth)
library(spbabel)

# ggplot theme
plot_theme <-   theme_minimal()+
  theme(text=element_text(family="Gill Sans MT",size=12,color="black"),
        legend.text = element_text(size=14),
        axis.title=element_text(family="sans",size=14,color="black"),
        axis.text=element_text(family="sans",size=8,color="black"),
        panel.grid.major = element_line(color="gray50",linetype=3))
theme_set(plot_theme)
```

```{r import data}
# File path where data are held
fp <- "C:/Users/Owen.Liu/Documents/NWFSC Research/Dungeness Fleet Dynamics/VMS DATA CONFIDENTIAL/Processed Data/VMS/"
fp_tix <- "C:/Users/Owen.Liu/Documents/NWFSC Research/Dungeness Fleet Dynamics/VMS DATA CONFIDENTIAL/Processed Data/Fish tickets/"

# Load Rdata files
# Interpolated, regularized VMS data, all years (spatial version)
vms_sf<-readRDS(file=paste0(fp,"VMS_int_reg_w_grid.rds"))

# non-spatial version of full VMS data
vms <- vms_sf
st_geometry(vms) <- NULL

# fish ticket data
load(file=paste0(fp_tix,"FishTix_all_2009_2018.RData"))

# a coastline, for plotting
# coastline for plotting
coaststates <- ne_states(country='United States of America',returnclass = 'sf') %>% 
  filter(name %in% c('California','Oregon','Washington'))
coastline <- ne_coastline(scale='medium',returnclass = 'sf') %>% 
  st_crop(st_bbox(coaststates))

```

Let's extract a random Dungeness crab trip from December 2010, a busy and productive crab season. Haphazardly, I chose the 100th trip amongst all Dec 2010 crab trips.

```{r extract sample trip}
trip1 <- vms_sf %>% 
  filter(TARGET_max=="DCRB",year(westcoastdate)==2010,month(westcoastdate)==12) %>% 
  group_by(Rec_ID) %>% 
  nest() %>% 
  ungroup() %>% 
  slice(100) %>% 
  unnest(cols = c(data)) %>% 
  st_as_sf(crs=st_crs(vms_sf)) %>% 
  st_transform(4326)

bbox <- st_bbox(trip1)

# plot
# sptable for drawing paths
trip_tbl <- trip1 %>% 
  spbabel::sptable()

ggplot()+
  geom_path(data=trip_tbl,aes(x_,y_),color="black")+
  geom_sf(data=coaststates,color='gray50')+
  theme(axis.text.x = element_text(angle=45))+
  coord_sf(xlim=c(bbox[1],bbox[3]),ylim=c(bbox[2],bbox[4]),crs=st_crs(coaststates))+
  labs(x="Longitude",y="Latitude",title="A DCRB Trip\nDec 02, 2010")
```

## Remove Transit Segments

The first step in processing is to remove the first and last segments of the trip, as they are likely associated with transiting into and out of port.

```{r remove segs}
trip1_trunc <- trip1 %>% slice(2:(n()-1))

trip_trunc_tbl <- trip1_trunc %>% 
  spbabel::sptable()

ggplot()+
  geom_path(data=trip_trunc_tbl,aes(x_,y_),color="black")+
  geom_sf(data=coaststates,color='gray50')+
  theme(axis.text.x = element_text(angle=45))+
  coord_sf(xlim=c(bbox[1],bbox[3]),ylim=c(bbox[2],bbox[4]),crs=st_crs(coaststates))+
  labs(x="Longitude",y="Latitude",title="A DCRB Trip\nDec 02, 2010\nFirst and Last Segments Removed")
```

## Calculate Distance

For the next step, we have to calculate the distance traveled by the vessel between these points

```{r calc dist}
trip1_coords <- trip1_trunc %>% 
  st_coordinates() %>% 
  as_tibble %>% 
  set_names(c('lon','lat'))

# Join trip identifiers from fish ticket data and then calculate distances along the path of each trip
trip1_dists <- trip1_coords %>% 
  mutate(last_x=lag(lon,1),last_y=lag(lat,1)) %>% 
  mutate(distance=distHaversine(cbind(lon,lat),cbind(last_x,last_y),r = 3963.19))

# summarize each trip, adding up total distance traveled
trip1_tot_dist <- sum(trip1_dists$distance,na.rm=T)
```

On this trip, based on our interpolated VMS data and *excluding* the first and last legs of the trip, this vessel traveled `r round(trip1_tot_dist,2)` miles. If we adopt the numbers from above that estimate a mean of 15 crab pots per linear mile, then our estimate would be that this trip involved interacting with ~`r round(trip1_tot_dist*15)` traps.

## Option 1: Convex Hull

Our first method is to draw a convex hull and then assign the appropriate number of traps randomly within that hull.

```{r conv hull,warning=FALSE,message=FALSE}
# calculate the convex hull
trip1_hull <- trip1_trunc %>% ungroup() %>% st_combine() %>% st_convex_hull()

# place random traps
num_traps <- round(trip1_tot_dist*15)
trip1_traps_opt1 <- st_sample(trip1_hull,num_traps)

ggplot()+
  geom_sf(data=trip1_hull,fill='darkblue',alpha=0.5)+
  geom_sf(data=trip1_traps_opt1,col='black',size=0.5)+
  geom_sf(data=coaststates,color='gray50')+
  theme(axis.text.x = element_text(angle=45))+
  coord_sf(xlim=c(bbox[1],bbox[3]),ylim=c(bbox[2],bbox[4]),crs=st_crs(coaststates))+
  labs(x="Longitude",y="Latitude",title="A DCRB Trip\nDec 02, 2010\nRandom Trap Placement")
```

## Option 2: Points on Straight Lines

For the second option, we retain the line segments from the vessel's trajectory, and assign our `r round(trip1_tot_dist*15)` traps along those lines.

```{r}
# formula to calculate the number of traps along a given line segment, assuming 15 traps/mile
calc_ntraps <- function(seg_length){
  floor(seg_length*15)
}

# create segments
trip1_lines <- trip1_trunc %>% 
  summarise(do_union=FALSE) %>% 
  st_cast("LINESTRING") %>% 
  st_segmentize(units::set_units(1/15,miles))

trip1_traps_opt2 <- trip1_lines[[1]] %>% st_cast("POINT")

ggplot()+
  geom_sf(data=trip1_traps_opt2,col='blue',size=0.3)+
  labs(x="Longitude",y="Latitude",title="A DCRB Trip\nDec 02, 2010\nLinear Trap Placement")
```

These two options produce quite different results.

```{r}
cols <- c("Random"="black","Linear"="blue","Convex Hull"="darkblue")
shapes <- c("Random"=16,"Linear"=16)
bbox=st_bbox(trip1_trunc)
ggplot()+
  geom_sf(data=trip1_hull,aes(fill="Convex Hull"),col=NA,alpha=0.5)+
  geom_sf(data=trip1_traps_opt1,aes(colour="Random"),size=0.5,shape=16)+
  geom_sf(data=coaststates,color='gray50')+
  geom_sf(data=trip1_traps_opt2,aes(colour="Linear"),size=0.3,shape=16)+
  scale_color_manual(name="Trap Placement Type",values=cols,
                     guide=guide_legend(override.aes = list(linetype=c('blank','blank'))))+
  scale_fill_manual(name="",values=cols)+
  theme(axis.text.x = element_text(angle=45))+
  coord_sf(xlim=c(bbox[1],bbox[3]),ylim=c(bbox[2],bbox[4]),crs=st_crs(coaststates))+
  labs(x="Longitude",y="Latitude",title="Random versus Linear Trap Placement")
```

## Option 3: Buffer

As an intermediate option, we can assign traps randomly, but place them within a specified distance of the VMS track. Because we do not know precisely where the vessels went outside of their hourly pings, this may be a good compromise between the total randomness of Option 1 and the rigid definition of Option 2.

```{r create buffer}
# what should the buffer size be? (in meters)
buffer_size <- 1000

# buffer lines
trip1_buffer <- trip1_lines %>% 
  st_transform(st_crs(vms_sf)) %>% 
  st_buffer(buffer_size)

# assign points
trip1_traps_opt3 <- trip1_buffer %>% st_sample(num_traps)

ggplot()+
  geom_sf(data=trip1_buffer,col='blue',size=0.3)+
  geom_sf(data=trip1_traps_opt3,col='black',size=0.3)+
  labs(x="Longitude",y="Latitude",title="A DCRB Trip with 1km buffer")
```


## Option 4: Jitter

Buffering can be computationally expensive when dealing with millions of observations, especially for trips that have crossing lines. Another option is to retain the line segmentation, but add noise ("jitter") to the data. Let's see how it looks. This will be the same as Option 2, but with some noise added in.

```{r jitter traps}
# create segments
trip1_jitter <- trip1_trunc %>% 
  summarise(do_union=FALSE) %>% 
  st_cast("LINESTRING") %>% 
  st_segmentize(units::set_units(1/15,miles))

trip1_traps_opt4 <- trip1_lines[[1]] %>% st_cast("POINT") %>% st_jitter(amount=0.01)

ggplot()+
  geom_sf(data=trip1_traps_opt4,col='blue',size=0.3)+
  labs(x="Longitude",y="Latitude",title="A DCRB Trip\nDec 02, 2010\nLinear Trap Placement with Jitter")

```

We will go with this for now. Can we apply this method to a larger set of trips?

# Assign Trap Locations to all Dungeness Trips

We'll apply Option 3 above to all trips in the data.

## Spatially Assign Traps

```{r calc traps}
# Function to apply the steps above
# the function takes a set of trip coordinates, a jitter amount in meters, and a number of traps/mile as input and returns a list of trap locations as output

assign_traps <- function(trip,ntraps_per_mi=15,jitter=1000) {
  
  out <- trip %>% 
    # make sure points are in time order
    arrange(westcoastdate) %>% 
    # remove first and last segments
    slice(2:(n()-1)) %>% 
    # make lines
    summarise(do_union=FALSE) %>%
    st_cast("LINESTRING") %>%
    # segment lines into number of traps
    st_segmentize(units::set_units(1/ntraps_per_mi,miles)) %>% 
    st_cast("POINT") %>% 
    # jitter the traps by a specified number of meters (i.e. draw a random displacement between -jitter and +jitter from a uniform distribution)
    st_jitter(amount=1000)

  return(out)
}

# Check with 5 example trips
p <- proc.time()
trip_test <- vms_sf %>% 
  filter(TARGET_max=="DCRB",year(westcoastdate)==2010,month(westcoastdate)==12) %>% 
  mutate(tripnum=group_indices(.,Rec_ID)) %>% 
  filter(tripnum<101) %>%
  group_by(Rec_ID) %>% 
  nest()
proc.time()-p

p <- proc.time()
test2 <- trip_test %>% mutate(traps=purrr::map(data,assign_traps))
proc.time()-p

ggplot()+
  geom_sf(data=trip_test$traps,col='black',size=0.3)+
  labs(x="Longitude",y="Latitude",title="Test of All-in-One Function")
```

## Apply to all Trips

This will take some processing time. It takes about a half second per trip, and if there are 50,000 trips...

```{r assign traps}
p <- proc.time()

nested_trips <- vms_sf %>% 
  filter(TARGET_max=="DCRB") %>% 
  group_by(Rec_ID) %>% 
  nest()

proc.time()-p

simulated_traps <- nested_trips %>%
  mutate(traps=purrr::map(data,assign_traps))

proc.time()-p
```


