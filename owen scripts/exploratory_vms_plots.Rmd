---
title: "Exploratory Plots"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r pkgs, include=FALSE,message=F,warning=FALSE}
library(tidyverse)
library(knitr)
library(extrafont)
library(ggsci)
library(lubridate)
library(sf)

# ggplot theme
plot_theme <-   theme_minimal()+
  theme(text=element_text(family="Gill Sans MT",size=12,color="black"),
        legend.text = element_text(size=14),
        axis.title=element_text(family="sans",size=14,color="black"),
        axis.text=element_text(family="sans",size=8,color="black"),
        panel.grid.major = element_line(color="gray50",linetype=3))
theme_set(plot_theme)
```

# Introduction

The purpose of this document is to produce a number of plots that describe the relationships between variables in the cleaned, interpolated VMS data for all years from 2009-2019.

The cleaning of the data has been done elsewhere, but for the purposes of the following plots, the important points are:

* Raw VMS data were cleaned and checked for errors, and then linearly interpolated and regularized. We linearly interpolated between recorded VMS points to obtain a relative measure of speed and distance traveled during each trip, then regularized those data, choosing points along the paths such that we have a VMS record for each vessel at more regular intervals.
* A fishing "trip" (the unit of many of the analyses below) is defined as the collection of VMS records preceding a landed, recorded PacFIN fish ticket. This means that one "trip" could involve multiple returns to port by a vessel across multiple days, as long as there is no ticket submitted within that time frame.
* In data processing, VMS records were assigned to fish tickets using two criteria. First, for each ticket, we looked backwards to see when the previous ticket had been submitted, and assigned all VMS records after the previous ticket to the current ticket. Second, for those vessels with long periods between submitted tickets, we enforced a 10 day "lookback window", such that the maximum number of calendar days of VMS records that could be associated with a single ticket is 10.
* We are focused here on fishing trips for Dungeness crab, but some vessels can participate in multiple fisheries. In data processing, if multiple tickets were submitted by a vessel on the same day, we denoted the primary target species for that trip as the species with the most landed pounds across all tickets. However, we also marked those trips so we can investigate any differences between single and multispecies fishing trips.

# General Trends

In this section, we summarize the data on broad scales to look at total landings over time and representation of the fleet through VMS records.

```{r import data}
# File path where data are held
fp <- "C:/Users/Owen.Liu/Documents/NWFSC Research/Dungeness Fleet Dynamics/VMS DATA CONFIDENTIAL/Processed Data/VMS/"
fp_tix <- "C:/Users/Owen.Liu/Documents/NWFSC Research/Dungeness Fleet Dynamics/VMS DATA CONFIDENTIAL/Processed Data/Fish tickets/"

# Load Rdata files
# Interpolated, regularized VMS data, all years 
vms_sf<-readRDS(file=paste0(fp,"VMS_int_reg_w_grid.rds"))

vms <- vms_sf
st_geometry(vms) <- NULL

# fish ticket data
load(file=paste0(fp_tix,"FishTix_all_2009_2018.RData"))
```

## Total Landings, Trips, and Number of Vessels over Time

First we organized the fish ticket data, so we can calculate quantities of interest like total landings per month, number of unique vessels, and whether or not a fish ticket is associated with VMS data.


```{r fishtix}
# Summarize fish tickets by target species as defined above, and denote whether each trip is multispecies
fishtix <- fishtix_basic_all %>% 
  
  # start with all fishtickets for the year
  select(Rec_ID,pacfin_port_code,drvid,date,TARGET,DCRB..lbs.,LOBS..lbs.,SABL..lbs.,SPRW..lbs.,OtherGear..lbs., Other..lbs.) %>%
  
  #rename port
  rename(Port_Of_Landing=pacfin_port_code) %>% 

  # group by vessel
  group_by(drvid) %>%
  arrange(desc(date),pmin(DCRB..lbs.,LOBS..lbs.,SABL..lbs.,SPRW..lbs.,OtherGear..lbs., Other..lbs.)) %>%
  
  # For multiple-ticket days,
  # define "TARGET" from the ticket with most landed pounds for that day, but also retain the other targets in a string
  group_by(drvid, date) %>% 
  mutate(all_spp=paste(TARGET,sep='',collapse=''),sumlbs=DCRB..lbs.+LOBS..lbs.+SABL..lbs.+SPRW..lbs.+OtherGear..lbs.+Other..lbs.) %>% 
  top_n(1,wt=sumlbs) %>% 
  select(-sumlbs) %>% 
  ungroup() %>% 
  
  # denote whether a trip is multispecies (binary)
  mutate(num_TARGET=nchar(all_spp)/4) %>% 
  mutate(date=as_date(date,format="%m/%d/%Y",tz="America/Los_Angeles")) %>% 
  mutate(month=month(date),year=year(date))
```

```{r}
# Add an indicator to fishtickets if they have associated VMS data
vms_fishtix_join <- vms %>% 
  select(Rec_ID) %>% 
  distinct() %>% 
  mutate(is_vms=1) %>% 
  right_join(fishtix,by="Rec_ID") %>% 
  mutate(is_vms=replace_na(is_vms,0))
```

### Total Dungeness Vessels

*  How many vessels recorded landings in each month in our data?
*  What proportion of vessels have associated VMS data in each month?

```{r count vessels}
nvessels_by_month <- vms_fishtix_join %>% 
  group_by(year,month,is_vms) %>% 
  summarise(nvessels=n_distinct(drvid)) %>% 
  ungroup() %>% 
  mutate(day=1) %>% 
  unite(date,year,month,day,sep="-",remove = FALSE) %>% 
  mutate(date=as_date(date,format="%Y-%m-%d",tz="America/Los_Angeles"))

nvessels_by_month %>% 
  ggplot(aes(date,nvessels,fill=factor(is_vms),col=factor(is_vms)))+
  geom_bar(stat='identity')+
  scale_fill_locuszoom(name="",labels=c("No VMS","VMS"))+
  scale_color_locuszoom(name="",labels=c("No VMS","VMS"))+
  scale_x_date(date_breaks= "6 months",date_labels="%b-%Y",expand=c(0,0))+
  labs(x="Date",y="Vessels Recording Landings",title="Number of Vessels by Month")+
  theme(axis.text.x.bottom = element_text(angle=90,vjust=+0.5,hjust=0),
        panel.grid.minor = element_blank())
```


### Total Landings

*  What are the total Dungeness landings represented in the fish ticket data over time?
*  What proportion of those landings are represented in our VMS records?

```{r}
landings_by_month <- vms_fishtix_join %>%
  group_by(year,month,is_vms) %>% 
  summarise(DCRB_lbs=sum(DCRB..lbs.)) %>%
  mutate(DCRB_mt=DCRB_lbs/2204.62) %>% 
  ungroup() %>% 
  mutate(day=1) %>% 
  unite(date,year,month,day,sep="-",remove = FALSE) %>% 
  mutate(date=as_date(date,format="%Y-%m-%d",tz="America/Los_Angeles"))

landings_by_month %>% 
  ggplot(aes(date,DCRB_lbs/1e6,fill=factor(is_vms),col=factor(is_vms)))+
  geom_bar(stat='identity')+
  scale_fill_locuszoom(labels=c("No VMS","VMS"),name="")+
  scale_color_locuszoom(labels=c("No VMS","VMS"),name="")+
  scale_x_date(date_breaks= "6 months",date_labels="%b-%Y",expand=c(0,0))+
  labs(x="Date",y="DCRB Landings (Million Lbs)",title="DCRB Landings by Month, all Tickets")+
  theme(legend.position = c(0.8,0.9))+
  theme(axis.text.x.bottom = element_text(angle=90,vjust=+0.5,hjust=0),
        panel.grid.minor = element_blank())

landings_by_year <- vms_fishtix_join %>%
  group_by(year,is_vms) %>% 
  summarise(DCRB_lbs=sum(DCRB..lbs.)) %>%
  mutate(DCRB_mt=DCRB_lbs/2204.62) %>% 
  ungroup()

landings_by_year %>% 
  ggplot(aes(year,DCRB_lbs/1e6,fill=factor(is_vms),col=factor(is_vms)))+
  geom_bar(stat='identity')+
  scale_fill_locuszoom(labels=c("No VMS","VMS"),name="")+
  scale_color_locuszoom(labels=c("No VMS","VMS"),name="")+
  labs(x="Year",y="DCRB Landings (Million Lbs)",title="DCRB Landings by Year, all Tickets")+
  theme(legend.position = c(0.8,0.9))
```


### Trips 

How many total trips targeting Dungeness were there over time? Here, trips are defined (as above) as individual fish tickets, where the target was "DCRB", or Dungeness crab. We distinguish whether or not these trips are associated with VMS data.

```{r calc trips}
trips_by_month <- vms_fishtix_join %>% 
  group_by(year,month,is_vms) %>% 
  filter(TARGET=="DCRB") %>% 
  summarise(n_trips=n_distinct(Rec_ID)) %>% 
  ungroup() %>% 
  mutate(day=1) %>% 
  unite(date,year,month,day,sep="-",remove = FALSE) %>% 
  mutate(date=as_date(date,format="%Y-%m-%d",tz="America/Los_Angeles"))

trips_by_year <- vms_fishtix_join %>% 
  group_by(year,is_vms) %>% 
  filter(TARGET=="DCRB") %>% 
  summarise(n_trips=n_distinct(Rec_ID)) %>% 
  ungroup()

trips_by_month %>% 
  ggplot(aes(date,n_trips,fill=factor(is_vms),col=factor(is_vms)))+
  geom_bar(stat='identity')+
  scale_fill_locuszoom(labels=c("No VMS","VMS"),name="")+
  scale_color_locuszoom(labels=c("No VMS","VMS"),name="")+
  scale_x_date(date_breaks= "6 months",date_labels="%b-%Y",expand=c(0,0))+
  labs(x="Date",y="DCRB Trips",title="Recorded DCRB Trips by Month")+
  theme(legend.position = c(0.8,0.9))+
  theme(axis.text.x.bottom = element_text(angle=90,vjust=+0.5,hjust=0),
        panel.grid.minor = element_blank())

trips_by_year %>% 
  ggplot(aes(year,n_trips,fill=factor(is_vms),col=factor(is_vms)))+
  geom_bar(stat='identity')+
  scale_fill_locuszoom(labels=c("No VMS","VMS"),name="")+
  scale_color_locuszoom(labels=c("No VMS","VMS"),name="")+
  labs(x="Date",y="DCRB Trips",title="Recorded DCRB Trips by Year")+
  theme(legend.position = c(0.8,0.9))
```

### Trips vs. Landings

Do more trips imply greater landings? How tight (linear) is this relationship? Does it differ between VMS and non-VMS tickets?

```{r join trips landings,message=F,warning=FALSE}
trips_land_by_month <- landings_by_month %>% 
  left_join(trips_by_month,by=c('year','month','day','date','is_vms'))

# Scatter plot
trips_land_by_month %>% 
  ggplot(aes(n_trips,DCRB_lbs/1e6,col=factor(is_vms),fill=factor(is_vms)))+
  geom_point()+
  # geom_smooth(method='lm',se=F)+
  geom_smooth()+
  scale_color_locuszoom(labels=c("No VMS","VMS"),name="")+
  scale_fill_locuszoom(labels=c("No VMS","VMS"),name="")+
  labs(x="Number of Trips",y="Total Monthly Landings (Million Lbs)",title="DCRB Trips versus Landings")
```

A couple of things to notice here. First, the relationship between trips and landings is nonlinear. This makes some sense in a derby-type fishery, which we can see in the monthly landings plots above: Early in each season, effort is intense and catches are extremely high. Later in the season as crabs become more scarce, fishers may require a relatively greater number of trips to obtain the desired catch. That is the likely reason for the shape of these curves.

Second, there is some scatter around the basic relationship between trips and landings, suggesting there are some anomalously good (above the line) and poor (below the line) months.

Finally, there is a stark difference between VMS and non-VMS vessels in this relationship. Vessels with VMS (for whatever reason), show relatively much higher monthly landings in fewer trips than non-VMS vessels. For example, in a month with ~1500 trips, VMS vessels could be expected to land approximately six million lbs of Dungeness, while non-VMS vessels would require twice that many trips to achieve the same landings. The exact reason for this discrepancy is unknown, but is likely a product of the relatively larger size and capcacity of VMS-equipped vessels. We can explore this further later on.

Next we turn to the calculation of catch-per-unit-effort, or CPUE, which describes the efficiency of fishing, and should shed further light on some of the relationships suggested in this plot.

## Catch per unit Effort

Here we explore the relationship between catch (landed pounds of crab) and effort. We will try to investigate whether there is consistency between different measures of effort (trips, VMS hours, distance traveled) in their relationships to landings.

### Trips vs. Landings

We got a sense of the (non-linear) relationship between trips and landings. We can look at this again through individual vessel cpue, and over time.

We can calculate number of trips and monthly landings On the individual vessel level (no longer summarizing over all vessels).

```{r calc trips by vessel}
trips_by_vessel_month <- vms_fishtix_join %>% 
  filter(TARGET=="DCRB") %>% 
  group_by(year,month,drvid,is_vms) %>% 
  summarise(n_trips=n_distinct(Rec_ID),tot_lbs=sum(DCRB..lbs.)) %>% 
  ungroup() %>% 
  mutate(day=1) %>% 
  unite(date,year,month,day,sep="-",remove = FALSE) %>% 
  mutate(date=as_date(date,format="%Y-%m-%d",tz="America/Los_Angeles"))

trips_by_vessel_month %>% 
  ggplot(aes(n_trips,tot_lbs/1e3,col=factor(is_vms),fill=factor(is_vms)))+
  geom_point()+
  # geom_smooth(method='lm',se=F)+
  geom_smooth()+
  scale_color_locuszoom(labels=c("No VMS","VMS"),name="")+
  scale_fill_locuszoom(labels=c("No VMS","VMS"),name="")+
  labs(x="Number of Trips",y="Total Monthly Landings (x1000 Lbs)",title="DCRB Trips versus Landings\nIndividual Vessels")
```

Here, it seems that there is immense individual variation in landings between vessels, with no clear indication that more trips in a month necessarily lead to more landings. However, there is some pattern to these data---The largest individual-vessel monthly landings occur with a small number of trips (~2-7 trips in a month). There are, in my mind, a couple of explanations for this pattern:

*  As in the previous section, we could be seeing an artifact of the fishery being very productive early in each season, with a relatively small number of trips leading to large amounts of landings.

*  In addtion to the seasonality, this observation could be partly due to the way we have defined trips (as all of the activity preceding a submitted landings receipt/fish ticket). Vessels can presumably transit in and out of port multiple times, storing catch before officially filling out a landings receipt. If this is the case, early in the season when the fishing is very good, fishers may be rushing to capture crab and only submitting tickets when they have filled available storage space. Later in the season, when many fishers are presumably more diversified, they may submit multiple smaller tickets at shorter time intervals. This would have the effect of increasing the number of trips rewquired to obtain a certain level of landings, which would help explain the phenomenon above.

We can investigate these two possibilities further by looking at CPUE over time and by substituting different measures of effort to replace trips and see if the relationships look similar.

### Landing per Trip over Time

```{r cpue over time}
cpue_by_month <- trips_by_vessel_month %>% 
  mutate(cpue_month=tot_lbs/n_trips) %>% 
  group_by(year,month,is_vms) %>% 
  summarise(mean_cpue=mean(cpue_month,na.rm=T),sd_cpue=sd(cpue_month,na.rm=T),
            upper=mean_cpue+sd_cpue,lower=pmax(0,mean_cpue-sd_cpue)) %>% mutate(day=1) %>% 
  unite(date,year,month,day,sep="-",remove = FALSE) %>% 
  mutate(date=as_date(date,format="%Y-%m-%d",tz="America/Los_Angeles"))

dodge <- position_dodge(width=40)
cpue_by_month %>% 
  ggplot(aes(date,mean_cpue,ymax=upper,ymin=lower,col=factor(is_vms),group=factor(is_vms)))+
  geom_pointrange(position = dodge,size=0.3)+
  scale_color_locuszoom(name="",labels=c("No VMS","VMS"))+
  labs(x="Date",y="Landings Per Trip (+/- 1 SD)",title="Landings Per Trip Over Time")+
  theme(panel.grid.minor = element_blank(),
        legend.position = c(0.9,0.9))
```

This is a messy plot, but the point is clear: At the individual vessel level, landings per trip peak early in the season and decline rapidly thereafter. One other thing I notice here is that again, VMS-equipped vessels (yellow) seem to have significantly higher landings per trip relative to their non-VMS counterparts (red).

